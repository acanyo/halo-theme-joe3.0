<!doctype html>
<html
  th:lang="${#locale.toLanguageTag}"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(title = ${category.spec.displayName}+'-'+${site.title},htmlType = category,header = null,leftSidebar = true,content = ~{::content}, head = null, footer = null)}"
>
  <th:block
    th:fragment="content"
    th:with="
      auth=${#authentication},
      isLoggedIn=${auth != null and auth.authenticated and auth.principal != 'anonymousUser'},
      userRoles=${isLoggedIn ? auth.authorities : {}},
      roleList=${isLoggedIn ? #lists.toList(userRoles.![authority]) : {}},
      publicUnauthCategory=${theme.config.permission.publicUnauthCategory != null ? theme.config.permission.publicUnauthCategory : true},
      publicUnauthPost=${theme.config.permission.publicUnauthPost != null ? theme.config.permission.publicUnauthPost : true},
      requiredRole = ${category.metadata.annotations != null ? category.metadata.annotations['role'] : null},
      hasRequiredRole = ${requiredRole != null and requiredRole != '' and requiredRole != 'public'},
      requiredRoleWithPrefix = ${hasRequiredRole ? ('ROLE_' + requiredRole) : null},
      isPublic = ${!hasRequiredRole and (publicUnauthCategory or isLoggedIn)},
      isAdmin = ${isLoggedIn and (#lists.contains(roleList, 'ROLE_super-role') or #lists.contains(roleList, 'ROLE_admin'))},
      hasRole = ${isLoggedIn and hasRequiredRole and (#lists.contains(roleList, requiredRole) or #lists.contains(roleList, requiredRoleWithPrefix))},
      hasPermission = ${isPublic or isAdmin or hasRole}"
  >
    <body>
      <!-- 权限检查：如果没有权限，显示提示页面 -->
      <th:block th:if="${!hasPermission}">
        <div id="Joe">
          <th:block th:replace="~{modules/macro/navbar :: navbar}" />
          <div class="joe_container joe_main_container" style="padding: 60px 20px;">
            <div class="joe_main">
              <div style="background: #fff; padding: 60px 40px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 80px; margin-bottom: 20px;">🔒</div>
                <h1 style="font-size: 32px; color: #333; margin-bottom: 20px;">此分类需要特定权限</h1>
                <th:block th:if="${!isLoggedIn}">
                  <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                    此分类仅对特定用户开放，请先登录查看
                  </p>
                  <a th:href="@{/console}" style="display: inline-block; padding: 12px 30px; background: var(--theme); color: #fff; border-radius: 4px; text-decoration: none; font-size: 16px;">
                    前往登录
                  </a>
                </th:block>
                <th:block th:if="${isLoggedIn}">
                  <p style="font-size: 16px; color: #666; margin-bottom: 20px;">
                    您当前的角色无权访问此分类
                  </p>
                  <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px; text-align: left;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
                      <strong>需要的角色：</strong>
                      <code th:text="${requiredRole}" style="background: #fff; padding: 4px 8px; border-radius: 3px; border: 1px solid #ddd;"></code>
                      或
                      <code th:text="${'ROLE_' + requiredRole}" style="background: #fff; padding: 4px 8px; border-radius: 3px; border: 1px solid #ddd;"></code>
                    </p>
                    <p style="font-size: 14px; color: #666; margin-bottom: 0;">
                      <strong>您当前的角色：</strong>
                      <th:block th:if="${#lists.isEmpty(roleList)}">
                        <span style="color: #999;">（无角色）</span>
                      </th:block>
                      <th:block th:if="${!#lists.isEmpty(roleList)}">
                        <th:block th:each="role, iterStat : ${roleList}">
                          <code th:text="${role}" style="background: #fff; padding: 4px 8px; border-radius: 3px; border: 1px solid #ddd; margin-right: 5px;"></code>
                        </th:block>
                      </th:block>
                    </p>
                  </div>
                  <a th:href="@{/}" style="display: inline-block; padding: 12px 30px; background: var(--theme); color: #fff; border-radius: 4px; text-decoration: none; font-size: 16px;">
                    返回首页
                  </a>
                </th:block>
              </div>
            </div>
          </div>
          <th:block th:replace="~{modules/common/footer :: footer}" />
        </div>
        <th:block th:replace="~{modules/macro/tail :: tail}" />
      </th:block>
      
      <!-- 有权限：显示分类内容 -->
      <th:block th:if="${hasPermission}">
      <div id="Joe">
        <th:block th:replace="~{modules/macro/navbar :: navbar}" />
        <!--          首页大图-->
        <th:block th:if="${theme.config.beauty.enable_big_banner}">
          <th:block th:replace="~{modules/macro/big_banner :: big_banner(${title})}" />
        </th:block>
        <div
          class="joe_container joe_main_container page-category"
          th:classappend="${theme.config.theme.enable_show_in_up ? 'animated fadeIn':''}"
        >
          <div class="joe_main">
            <div class="joe_archive">
              <div class="joe_archive__title">
                <div class="joe_archive__title-title">
                  <i class="joe-font joe-icon-feather joe_archive__title-icon"></i>以下是
                  <span class="muted ellipsis">[[${category.spec.displayName}]]</span>
                  <span>相关的文章</span>
                </div>
              </div>

              <ul class="joe_archive__list joe_list">
                <th:block th:each="post, iteration : ${posts.items}">
                  <!-- 权限检查：只显示用户有权限访问的文章 -->
                  <th:block
                    th:with="
                      postRequiredRole = ${post.metadata.annotations != null ? post.metadata.annotations['role'] : null},
                      postHasRequiredRole = ${postRequiredRole != null and postRequiredRole != '' and postRequiredRole != 'public'},
                      postIsPublic = ${!postHasRequiredRole and (publicUnauthPost or isLoggedIn)},
                      postHasRole = ${isLoggedIn and postHasRequiredRole and #lists.contains(roleList, postRequiredRole)},
                      postHasPermission = ${postIsPublic or isAdmin or hasPostBypass or postHasRole}"
                  >
                    <th:block th:if="${postHasPermission}">
                      <th:block th:replace="~{modules/macro/post_item :: post_item}" />
                    </th:block>
                  </th:block>
                </th:block>
              </ul>
              <th:block th:replace="~{modules/common/pagination :: category}" />
            </div>
          </div>
        </div>
        <th:block th:replace="~{modules/common/actions :: actions}" />
        <th:block th:replace="~{modules/common/footer :: footer}" />
      </div>
      <th:block th:replace="~{modules/macro/tail :: tail}" />
      </th:block>
      <!-- 结束有权限的内容显示 -->
    </body>
  </th:block>
</html>
