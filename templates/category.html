<!doctype html>
<html
  th:lang="${#locale.toLanguageTag}"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(title = ${category.spec.displayName}+'-'+${site.title},htmlType = category,header = null,leftSidebar = true,content = ~{::content}, head = null, footer = null)}"
>
  <th:block
    th:fragment="content"
    th:with="
      auth=${#authentication},
      isLoggedIn=${auth != null and auth.authenticated and auth.principal != 'anonymousUser'},
      userRoles=${isLoggedIn ? auth.authorities : {}},
      roleList=${isLoggedIn ? #lists.toList(userRoles.![authority]) : {}},
      requiredRole = ${category.metadata.annotations != null ? category.metadata.annotations['role'] : null},
      isPublic = ${requiredRole == null or requiredRole == '' or requiredRole == 'public'},
      isAdmin = ${isLoggedIn and (#lists.contains(roleList, 'ROLE_super-role') or #lists.contains(roleList, 'ROLE_admin'))},
      hasRole = ${isLoggedIn and requiredRole != null and #lists.contains(roleList, requiredRole)},
      hasPermission = ${isPublic or isAdmin or hasRole}"
  >
    <body>
      <!-- 权限检查：如果没有权限，显示提示页面 -->
      <th:block th:if="${!hasPermission}">
        <div id="Joe">
          <th:block th:replace="~{modules/macro/navbar :: navbar}" />
          <div class="joe_container joe_main_container" style="padding: 60px 20px;">
            <div class="joe_main">
              <div style="background: #fff; padding: 60px 40px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 80px; margin-bottom: 20px;">🔒</div>
                <h1 style="font-size: 32px; color: #333; margin-bottom: 20px;">此分类需要特定权限</h1>
                <th:block th:if="${!isLoggedIn}">
                  <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                    此分类仅对特定用户开放，请先登录查看
                  </p>
                  <a th:href="@{/console}" style="display: inline-block; padding: 12px 30px; background: var(--theme); color: #fff; border-radius: 4px; text-decoration: none; font-size: 16px;">
                    前往登录
                  </a>
                </th:block>
                <th:block th:if="${isLoggedIn}">
                  <p style="font-size: 16px; color: #666; margin-bottom: 20px;">
                    您当前的角色无权访问此分类
                  </p>
                  <p style="font-size: 14px; color: #999; margin-bottom: 30px;">
                    需要角色：<code th:text="${requiredRole}" style="background: #f5f5f5; padding: 4px 8px; border-radius: 3px;"></code>
                  </p>
                  <a th:href="@{/}" style="display: inline-block; padding: 12px 30px; background: var(--theme); color: #fff; border-radius: 4px; text-decoration: none; font-size: 16px;">
                    返回首页
                  </a>
                </th:block>
              </div>
            </div>
          </div>
          <th:block th:replace="~{modules/common/footer :: footer}" />
        </div>
        <th:block th:replace="~{modules/macro/tail :: tail}" />
      </th:block>
      
      <!-- 有权限：显示分类内容 -->
      <th:block th:if="${hasPermission}">
      <div id="Joe">
        <th:block th:replace="~{modules/macro/navbar :: navbar}" />
        <!--          首页大图-->
        <th:block th:if="${theme.config.beauty.enable_big_banner}">
          <th:block th:replace="~{modules/macro/big_banner :: big_banner(${title})}" />
        </th:block>
        <div
          class="joe_container joe_main_container page-category"
          th:classappend="${theme.config.theme.enable_show_in_up ? 'animated fadeIn':''}"
        >
          <div class="joe_main">
            <div class="joe_archive">
              <div class="joe_archive__title">
                <div class="joe_archive__title-title">
                  <i class="joe-font joe-icon-feather joe_archive__title-icon"></i>以下是
                  <span class="muted ellipsis">[[${category.spec.displayName}]]</span>
                  <span>相关的文章</span>
                </div>
              </div>

              <ul class="joe_archive__list joe_list">
                <th:block th:each="post, iteration : ${posts.items}">
                  <!-- 权限检查：只显示用户有权限访问的文章 -->
                  <th:block
                    th:with="
                      postRequiredRole = ${post.metadata.annotations != null ? post.metadata.annotations['role'] : null},
                      postIsPublic = ${postRequiredRole == null or postRequiredRole == '' or postRequiredRole == 'public'},
                      postHasRole = ${isLoggedIn and postRequiredRole != null and #lists.contains(roleList, postRequiredRole)},
                      postHasPermission = ${postIsPublic or isAdmin or postHasRole}"
                  >
                    <th:block th:if="${postHasPermission}">
                      <th:block th:replace="~{modules/macro/post_item :: post_item}" />
                    </th:block>
                  </th:block>
                </th:block>
              </ul>
              <th:block th:replace="~{modules/common/pagination :: category}" />
            </div>
          </div>
        </div>
        <th:block th:replace="~{modules/common/actions :: actions}" />
        <th:block th:replace="~{modules/common/footer :: footer}" />
      </div>
      <th:block th:replace="~{modules/macro/tail :: tail}" />
      </th:block>
      <!-- 结束有权限的内容显示 -->
    </body>
  </th:block>
</html>
