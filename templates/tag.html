<!doctype html>
<html
  th:lang="${#locale.toLanguageTag}"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(title = ${tag.spec.displayName}+'-'+${site.title},htmlType = tag,header = null,leftSidebar = true,content = ~{::content}, head = null, footer = null)}"
>
  <th:block
    th:fragment="content"
    th:with="
      auth=${#authentication},
      isLoggedIn=${auth != null and auth.authenticated and auth.principal != 'anonymousUser'},
      userRoles=${isLoggedIn ? auth.authorities : {}},
      roleList=${isLoggedIn ? #lists.toList(userRoles.![authority]) : {}},
      isAdmin = ${isLoggedIn and (#lists.contains(roleList, 'ROLE_super-role') or #lists.contains(roleList, 'ROLE_admin'))}"
  >
    <body>
      <div id="Joe">
        <th:block th:replace="~{modules/macro/navbar :: navbar}" />
        <!--          首页大图-->
        <th:block th:if="${theme.config.beauty.enable_big_banner}">
          <th:block th:replace="~{modules/macro/big_banner :: big_banner(${title})}" />
        </th:block>
        <div
          class="joe_container joe_main_container page-tag"
          th:classappend="${theme.config.theme.enable_show_in_up ? 'animated fadeIn':''}"
        >
          <div class="joe_main">
            <div class="joe_archive">
              <div class="joe_archive__title">
                <div class="joe_archive__title-title">
                  <i class="joe-font joe-icon-feather joe_archive__title-icon"></i>以下是
                  <span class="muted ellipsis">[[${tag.spec.displayName}]]</span>
                  <span>相关的文章</span>
                </div>
              </div>

              <ul class="joe_archive__list joe_list" data-wow="off">
                <th:block th:each="post, iteration : ${posts.items}">
                  <!-- 权限检查：只显示用户有权限访问的文章 -->
                  <th:block
                    th:with="
                      requiredRole = ${post.metadata.annotations != null ? post.metadata.annotations['role'] : null},
                      isPublic = ${requiredRole == null or requiredRole == '' or requiredRole == 'public'},
                      hasRole = ${isLoggedIn and requiredRole != null and #lists.contains(roleList, requiredRole)},
                      hasPermission = ${isPublic or isAdmin or hasRole}"
                  >
                    <th:block th:if="${hasPermission}">
                      <th:block th:replace="~{modules/macro/post_item :: post_item}" />
                    </th:block>
                  </th:block>
                </th:block>
              </ul>
              <th:block th:replace="~{modules/common/pagination :: tag}" />
            </div>
          </div>
        </div>
        <th:block th:replace="~{modules/common/actions :: actions}" />
        <th:block th:replace="~{modules/common/footer :: footer}" />
      </div>
      <th:block th:replace="~{modules/macro/tail :: tail}" />
    </body>
  </th:block>
</html>
