<!doctype html>
<html
  th:lang="${#locale.toLanguageTag}"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(title = ${site.title},htmlType = sheet,header = null,leftSidebar = true,content = ~{::content}, head = null, footer = null)}"
>
  <th:block
    th:fragment="content"
    th:with="
      auth=${#authentication},
      isLoggedIn=${auth != null and auth.authenticated and auth.principal != 'anonymousUser'},
      userRoles=${isLoggedIn ? auth.authorities : {}},
      roleList=${isLoggedIn ? #lists.toList(userRoles.![authority]) : {}},
      publicUnauthPage=${theme.config.permission.publicUnauthPage != null ? theme.config.permission.publicUnauthPage : true},
      requiredRole = ${singlePage.metadata.annotations != null ? singlePage.metadata.annotations['role'] : null},
      hasRequiredRole = ${requiredRole != null and requiredRole != '' and requiredRole != 'public'},
      requiredRoleWithPrefix = ${hasRequiredRole ? ('ROLE_' + requiredRole) : null},
      isPublic = ${!hasRequiredRole and (publicUnauthPage or isLoggedIn)},
      isAdmin = ${isLoggedIn and (#lists.contains(roleList, 'ROLE_super-role') or #lists.contains(roleList, 'ROLE_admin'))},
      hasRole = ${isLoggedIn and hasRequiredRole and (#lists.contains(roleList, requiredRole) or #lists.contains(roleList, requiredRoleWithPrefix))},
      hasPermission = ${isPublic or isAdmin or hasRole}"
  >
    <body>
      <!-- æƒé™æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰æƒé™ï¼Œæ˜¾ç¤ºæç¤ºé¡µé¢ -->
      <th:block th:if="${!hasPermission}">
        <div id="Joe">
          <th:block th:replace="~{modules/macro/navbar :: navbar}" />
          <div class="joe_container joe_main_container" style="padding: 60px 20px;">
            <div class="joe_main">
              <div style="background: #fff; padding: 60px 40px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 80px; margin-bottom: 20px;">ğŸ”’</div>
                <h1 style="font-size: 32px; color: #333; margin-bottom: 20px;">æ­¤é¡µé¢éœ€è¦ç‰¹å®šæƒé™</h1>
                <th:block th:if="${!isLoggedIn}">
                  <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                    æ­¤é¡µé¢ä»…å¯¹ç‰¹å®šç”¨æˆ·å¼€æ”¾ï¼Œè¯·å…ˆç™»å½•æŸ¥çœ‹
                  </p>
                  <a th:href="@{/console}" style="display: inline-block; padding: 12px 30px; background: var(--theme); color: #fff; border-radius: 4px; text-decoration: none; font-size: 16px;">
                    å‰å¾€ç™»å½•
                  </a>
                </th:block>
                <th:block th:if="${isLoggedIn}">
                  <p style="font-size: 16px; color: #666; margin-bottom: 20px;">
                    æ‚¨å½“å‰çš„è§’è‰²æ— æƒè®¿é—®æ­¤é¡µé¢
                  </p>
                  <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px; text-align: left;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
                      <strong>éœ€è¦çš„è§’è‰²ï¼š</strong>
                      <code th:text="${requiredRole}" style="background: #fff; padding: 4px 8px; border-radius: 3px; border: 1px solid #ddd;"></code>
                      æˆ–
                      <code th:text="${'ROLE_' + requiredRole}" style="background: #fff; padding: 4px 8px; border-radius: 3px; border: 1px solid #ddd;"></code>
                    </p>
                    <p style="font-size: 14px; color: #666; margin-bottom: 0;">
                      <strong>æ‚¨å½“å‰çš„è§’è‰²ï¼š</strong>
                      <th:block th:if="${#lists.isEmpty(roleList)}">
                        <span style="color: #999;">ï¼ˆæ— è§’è‰²ï¼‰</span>
                      </th:block>
                      <th:block th:if="${!#lists.isEmpty(roleList)}">
                        <th:block th:each="role, iterStat : ${roleList}">
                          <code th:text="${role}" style="background: #fff; padding: 4px 8px; border-radius: 3px; border: 1px solid #ddd; margin-right: 5px;"></code>
                        </th:block>
                      </th:block>
                    </p>
                  </div>
                  <a th:href="@{/}" style="display: inline-block; padding: 12px 30px; background: var(--theme); color: #fff; border-radius: 4px; text-decoration: none; font-size: 16px;">
                    è¿”å›é¦–é¡µ
                  </a>
                </th:block>
              </div>
            </div>
          </div>
          <th:block th:replace="~{modules/common/footer :: footer}" />
        </div>
        <th:block th:replace="~{modules/macro/tail :: tail}" />
      </th:block>
      
      <!-- æœ‰æƒé™ï¼šæ˜¾ç¤ºé¡µé¢å†…å®¹ -->
      <th:block th:if="${hasPermission}">
      <div id="Joe">
        <th:block th:replace="~{modules/macro/navbar :: navbar}" />
        <div
          class="joe_container joe_main_container page-sheet"
          th:classappend="|${theme.config.theme.enable_show_in_up ? 'animated showInUp':''} ${theme.config.aside.aside_position == 'left' ? 'revert':''}|"
        >
          <div class="joe_main">
            <div
              class="joe_detail"
              th:with="contributor = ${contributorFinder.getContributor(singlePage.status.contributors[0])}"
            >
              <h1
                class="joe_detail__title"
                th:classappend="${theme.config.post.enable_title_shadow ? 'txt-shadow':''}"
              >
                [[${singlePage.spec.title}]]
              </h1>
              <th:block
                th:if="${theme.config.post.enable_page_meta} and ${#annotations.getOrDefault(singlePage, 'enable_page_meta', 'true')}"
              >
                <div class="joe_detail__count">
                  <div class="joe_detail__count-information">
                    <img
                      width="35"
                      height="35"
                      class="avatar lazyload"
                      th:src="${theme.config.blogger.lazyload_avatar}"
                      th:data-src="${contributor.avatar}"
                      th:alt="${contributor.displayName}"
                      onerror="Joe.errorImg(this, 'ErrAvatarImg')"
                    />
                    <div class="meta">
                      <div class="author">
                        <a
                          class="link"
                          th:href="${contributor.permalink}"
                          th:title="${contributor.displayName}"
                          >[[${contributor.displayName}]]</a
                        >
                      </div>
                      <div class="item">
                        <span class="text"
                          >[[${#dates.format(singlePage.spec.publishTime,'yyyy-MM-dd')}]]</span
                        >
                        <span class="line">/</span>
                        <th:block
                          th:if="${theme.config.basic.comment_option == 'default'} or ${#strings.trim(theme.config.basic.waline.waline_serverURL) ==''}"
                        >
                          <span class="text">[[${singlePage.stats.comment}]] è¯„è®º</span>
                        </th:block>
                        <th:block
                          th:if="${theme.config.basic.comment_option == 'waline'} and ${#strings.trim(theme.config.basic.waline.waline_serverURL) !=''}"
                        >
                          <span
                            class="text waline-comment-count"
                            th:data-path="@{${singlePage.status.permalink}}"
                            >0</span
                          >&nbsp;è¯„è®º
                        </th:block>
                        <span class="line">/</span>
                        <span class="text">[[${singlePage.stats.visit}]] é˜…è¯»</span>
                        <span class="line">/</span>
                        <span class="text" id="wordCount">0 å­—</span>
                        <th:block
                          th:if="${#annotations.getOrDefault(singlePage, 'enable_collect_check', 'true')} and ${theme.config.other.check_baidu_collect}"
                        >
                          <span class="line">/</span>
                          <span class="text" id="joe_baidu_record">æ­£åœ¨æ£€æµ‹æ˜¯å¦æ”¶å½•...</span>
                        </th:block>
                      </div>
                    </div>
                  </div>
                  <time
                    class="joe_detail__count-created"
                    th:datetime="${#dates.format(singlePage.status.lastModifyTime,'MM/dd')}"
                    >[[${#dates.format(singlePage.status.lastModifyTime,'MM/dd')}]]</time
                  >
                </div>
              </th:block>

              <article
                th:class="'joe_detail__article animated fadeIn '+${#annotations.getOrDefault(singlePage, 'img_align', 'center')+'-img'}"
                th:classappend="|${(#annotations.getOrDefault(singlePage, 'enable_read_limit', 'false') == 'true' && (#authentication.name == 'anonymousUser' || contributor.name != #authentication.name)) ? 'limited': ''} ${(#annotations.getOrDefault(singlePage, 'enable_copy', 'true') == 'false' or theme.config.post.enable_copy != true) ? 'uncopy' : ''} ${theme.config.post.enable_indent ? 'indent':''} ${(theme.config.code_block.enable_code_line_number == true and theme.config.code_block.enable_code_newline !=true) ? 'line-numbers':''} ${theme.config.code_block.enable_single_code_select == true ? 'single_code_select': ''}|"
              >
                <div id="singlePage-inner">
                  <th:block
                    th:if="${#annotations.getOrDefault(singlePage, 'use_raw_content', 'false') == 'false'}"
                  >
                    <th:block th:utext="${singlePage.content.content}"></th:block>
                  </th:block>
                  <th:block
                    th:if="${#annotations.getOrDefault(singlePage, 'use_raw_content', 'false') =='true'}"
                  >
                    <joe-raw-content>
                      <div id="_raw">[[${singlePage.content.content}]]</div>
                    </joe-raw-content>
                  </th:block>
                </div>
                <th:block
                  th:if="${#annotations.getOrDefault(singlePage, 'enable_read_limit', 'false') == 'true' && (#authentication.name == 'anonymousUser' || contributor.name != #authentication.name)}"
                  th:with="authenticationDisplayName=${#authentication.name == 'anonymousUser' ? 'æ¸¸å®¢' : contributorFinder.getContributor(#authentication.name).displayName}"
                >
                  >
                  <joe-read-limited
                    th:username="${#authentication.name}"
                    th:display-name="${authenticationDisplayName}"
                    th:comment-name="${singlePage.metadata.name}"
                    th:comment-kind="SinglePage"
                    th:comment-plugin="${(theme.config.basic.comment_option == 'default' || #strings.trim(theme.config.basic.waline.waline_serverURL) =='') ? 'CommentWidgetPlugin' : 'WalinePlugin'}"
                  ></joe-read-limited>
                </th:block>
              </article>
            </div>
            <th:block
              th:if="${theme.config.other.enable_clean_mode != true} and ${theme.config.post.enable_comment}"
            >
              <div class="joe_comment">
                <th:block
                  th:if="${#annotations.getOrDefault(singlePage, 'enable_comment', 'true') != 'true'}"
                >
                  <div class="joe_comment__close">
                    <svg
                      class="joe_comment__close-icon"
                      viewBox="0 0 1024 1024"
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                    >
                      <path
                        d="M512.307.973c282.317 0 511.181 201.267 511.181 449.587a402.842 402.842 0 0 1-39.27 173.26 232.448 232.448 0 0 0-52.634-45.977c16.384-39.782 25.293-82.688 25.293-127.283 0-211.098-199.117-382.157-444.621-382.157-245.555 0-444.57 171.06-444.57 382.157 0 133.427 79.514 250.88 200.039 319.18v107.982l102.041-65.127a510.157 510.157 0 0 0 142.49 20.122l19.405-.359c19.405-.716 38.758-2.508 57.958-5.427l3.584 13.415a230.607 230.607 0 0 0 22.323 50.688l-20.633 3.328a581.478 581.478 0 0 1-227.123-12.288L236.646 982.426c-19.66 15.001-35.635 7.168-35.635-17.664v-157.39C79.411 725.198 1.024 595.969 1.024 450.56 1.024 202.24 229.939.973 512.307.973zm318.464 617.011c97.485 0 176.794 80.435 176.794 179.2S928.256 976.23 830.77 976.23c-97.433 0-176.742-80.281-176.742-179.046 0-98.816 79.309-179.149 176.742-179.149zM727.757 719.002a131.174 131.174 0 0 0-25.754 78.182c0 71.885 57.805 130.406 128.768 130.406 28.877 0 55.552-9.625 77.056-26.01zm103.014-52.327c-19.712 0-39.117 4.557-56.678 13.312L946.33 854.58c8.499-17.305 13.158-36.864 13.158-57.395 0-71.987-57.805-130.509-128.717-130.509zM512.307 383.13l6.861.358a67.072 67.072 0 0 1 59.853 67.072l-.307 6.86a67.072 67.072 0 0 1-66.407 60.57l-6.81-.358a67.072 67.072 0 0 1-59.852-67.072 67.072 67.072 0 0 1 66.662-67.43zm266.752 0l6.861.358a67.072 67.072 0 0 1 59.853 67.072l-.307 6.86a67.072 67.072 0 0 1-66.407 60.57l-6.81-.358a67.072 67.072 0 0 1-59.852-67.072h-.051l.307-6.86a67.072 67.072 0 0 1 66.406-60.57zm-533.504 0l6.861.358a67.072 67.072 0 0 1 59.853 67.072l-.307 6.86a67.072 67.072 0 0 1-66.407 60.57l-6.81-.358a67.072 67.072 0 0 1-59.852-67.072 67.072 67.072 0 0 1 66.662-67.43z"
                      />
                    </svg>
                    <span>åšä¸»å…³é—­äº†å½“å‰é¡µé¢çš„è¯„è®º</span>
                  </div>
                </th:block>
                <th:block
                  th:if="${#annotations.getOrDefault(singlePage, 'enable_comment', 'true') == 'true'}"
                >
                  <th:block
                    th:replace="~{modules/macro/comment :: comment(name=${singlePage.metadata.name}, kind='SinglePage')}"
                  />
                </th:block>
              </div>
            </th:block>
            <th:block
              th:if="${theme.config.other.enable_clean_mode == true} or ${theme.config.post.enable_comment !=true}"
            >
              <div class="joe_comment">
                <div class="joe_comment__close">
                  <svg
                    class="joe_comment__close-icon"
                    viewBox="0 0 1024 1024"
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                  >
                    <path
                      d="M512.307.973c282.317 0 511.181 201.267 511.181 449.587a402.842 402.842 0 0 1-39.27 173.26 232.448 232.448 0 0 0-52.634-45.977c16.384-39.782 25.293-82.688 25.293-127.283 0-211.098-199.117-382.157-444.621-382.157-245.555 0-444.57 171.06-444.57 382.157 0 133.427 79.514 250.88 200.039 319.18v107.982l102.041-65.127a510.157 510.157 0 0 0 142.49 20.122l19.405-.359c19.405-.716 38.758-2.508 57.958-5.427l3.584 13.415a230.607 230.607 0 0 0 22.323 50.688l-20.633 3.328a581.478 581.478 0 0 1-227.123-12.288L236.646 982.426c-19.66 15.001-35.635 7.168-35.635-17.664v-157.39C79.411 725.198 1.024 595.969 1.024 450.56 1.024 202.24 229.939.973 512.307.973zm318.464 617.011c97.485 0 176.794 80.435 176.794 179.2S928.256 976.23 830.77 976.23c-97.433 0-176.742-80.281-176.742-179.046 0-98.816 79.309-179.149 176.742-179.149zM727.757 719.002a131.174 131.174 0 0 0-25.754 78.182c0 71.885 57.805 130.406 128.768 130.406 28.877 0 55.552-9.625 77.056-26.01zm103.014-52.327c-19.712 0-39.117 4.557-56.678 13.312L946.33 854.58c8.499-17.305 13.158-36.864 13.158-57.395 0-71.987-57.805-130.509-128.717-130.509zM512.307 383.13l6.861.358a67.072 67.072 0 0 1 59.853 67.072l-.307 6.86a67.072 67.072 0 0 1-66.407 60.57l-6.81-.358a67.072 67.072 0 0 1-59.852-67.072 67.072 67.072 0 0 1 66.662-67.43zm266.752 0l6.861.358a67.072 67.072 0 0 1 59.853 67.072l-.307 6.86a67.072 67.072 0 0 1-66.407 60.57l-6.81-.358a67.072 67.072 0 0 1-59.852-67.072h-.051l.307-6.86a67.072 67.072 0 0 1 66.406-60.57zm-533.504 0l6.861.358a67.072 67.072 0 0 1 59.853 67.072l-.307 6.86a67.072 67.072 0 0 1-66.407 60.57l-6.81-.358a67.072 67.072 0 0 1-59.852-67.072 67.072 67.072 0 0 1 66.662-67.43z"
                    />
                  </svg>
                  <span>åšä¸»å…³é—­äº†æ‰€æœ‰é¡µé¢çš„è¯„è®º</span>
                </div>
              </div>
            </th:block>
          </div>

          <th:block th:if="${theme.config.aside.enable_sheet_aside}">
            <th:block th:replace="~{modules/common/aside :: aside}" />
          </th:block>
        </div>
        <!--    action-->
        <th:block
          th:with="contributor = ${contributorFinder.getContributor(singlePage.status.contributors[0])}"
        >
          <th:block
            th:replace="~{modules/common/actions :: actions_edit(contributor=${contributor.name})}"
          />
        </th:block>
        <th:block th:replace="~{modules/common/footer :: footer}" />
      </div>
      <script>
        // ç­‰å¾…æ–‡æ¡£åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function () {
          // è·å–æ–‡ç« å†…å®¹
          const postContent = document.getElementById('singlePage-inner').innerText || '';

          // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸­æ–‡ã€æ•°å­—å’Œå­—æ¯
          const matches = postContent.match(/[\u4e00-\u9fa5a-zA-Z0-9]/g);

          // è®¡ç®—æœ‰æ•ˆå­—ç¬¦æ•°
          const wordCount = matches ? matches.length : 0;

          // æ›´æ–°å­—æ•°ç»Ÿè®¡æ˜¾ç¤º
          document.getElementById('wordCount').innerText = `${wordCount} å­—`;
        });
      </script>
      <th:block th:replace="~{modules/macro/tail :: tail}" />
      </th:block>
      <!-- ç»“æŸæœ‰æƒé™çš„å†…å®¹æ˜¾ç¤º -->
    </body>
  </th:block>
</html>
